<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¶…å®Œæ•´ç‰ˆç‹¼äººæ®ºã€25è§’è‰²ï½œç¹é«”ä¸­æ–‡ï½œè¦å‰‡å…¨é½Šã€‘</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; }
        body { background: #1a1a1a; color: #f5f5f5; line-height: 1.6; padding: 15px; }
        .game-container { max-width: 900px; margin: 0 auto; background: #2d2d2d; border-radius: 12px; padding: 20px; border: 2px solid #555; }
        h1, h2, h3 { text-align: center; color: #ff9500; margin: 10px 0; }
        h1 { border-bottom: 3px solid #ff9500; padding-bottom: 10px; }
        .log-box { background: #121212; min-height: 450px; max-height: 450px; overflow-y: auto; padding: 15px; border-radius: 8px; margin: 15px 0; border: 1px solid #444; white-space: pre-line; font-size: 15px; }
        .input-box { display: flex; gap: 10px; align-items: center; justify-content: center; margin: 15px 0; }
        #gameInput { flex: 1; padding: 12px; border-radius: 6px; border: none; background: #3d3d3d; color: #fff; font-size: 16px; outline: none; }
        #gameInput:focus { border: 2px solid #ff9500; }
        #submitBtn { padding: 12px 25px; border-radius: 6px; border: none; background: #ff9500; color: #1a1a1a; font-weight: bold; font-size: 16px; cursor: pointer; }
        #submitBtn:hover { background: #e08800; }
        .good { color: #4cd964; }
        .wolf { color: #ff3b30; }
        .warn { color: #ffcc00; }
        .success { color: #00e676; }
        .danger { color: #ff5252; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #2d2d2d; }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #777; }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>ğŸº ç‹¼äººæ®ºã€è¶…å®Œæ•´ç‰ˆ25è§’è‰²ï½œç¹é«”ä¸­æ–‡ã€‘ğŸº</h1>
        <h3>è¦å‰‡å…¨é½Šï½œæ‰‹å‹•è¨­å®šï½œé‡é–‹åˆ†é…ï½œæ—¥å¤œå¾ªç’°</h3>
        <div class="log-box" id="gameLog"></div>
        <div class="input-box">
            <input type="text" id="gameInput" placeholder="è«‹è¼¸å…¥æ•¸å­—æŒ‰éˆ•ç¢ºèªï¼Œè¼¸å…¥å…§å®¹å¾ŒæŒ‰ç¢ºèªéµ...">
            <button id="submitBtn">ç¢º èª</button>
        </div>
    </div>

    <script>
        // ========== ç‹¼äººæ®ºè§’è‰²å®šç¾©ã€å®Œæ•´25è§’è‰²ï½œç¹é«”ä¸­æ–‡ï½œå«é™£ç‡Ÿ+æŠ€èƒ½èªªæ˜ï½œè¦å‰‡100%å°é½Šã€‘ ==========
        const ROLES = {
            1: {"name": "å¹³æ°‘", "team": "å¥½äººé™£ç‡Ÿ", "skill": "ç„¡ç‰¹æ®ŠæŠ€èƒ½ï¼Œç™½å¤©æŠ•ç¥¨æ”¾é€ç‹¼äºº"},
            2: {"name": "å¥³å·«", "team": "å¥½äººé™£ç‡Ÿ", "skill": "è§£è—¥x1ï¼šæ•‘ç‹¼åˆ€ç›®æ¨™ï¼Œç¬¬ä¸€æ™šä¸èƒ½è‡ªæ•‘ï¼›æ¯’è—¥x1ï¼šæ¯’æ®ºç©å®¶ä¸¦å°å°æŠ€èƒ½ï¼Œå…©è—¥ä¸å¯åŒå¤œä½¿ç”¨"},
            3: {"name": "é è¨€å®¶", "team": "å¥½äººé™£ç‡Ÿ", "skill": "æ¯æ™šæŸ¥é©—1åå­˜æ´»ç©å®¶çš„èº«ä»½ï¼ˆå¥½äºº/ç‹¼äººï¼‰"},
            4: {"name": "çµäºº", "team": "å¥½äººé™£ç‡Ÿ", "skill": "è¢«åˆ€/è¢«æŠ•å¯é–‹æ§å¸¶äººï¼Œè¢«æ¯’å‰‡å¤±æ•ˆ"},
            5: {"name": "å®ˆè¡›", "team": "å¥½äººé™£ç‡Ÿ", "skill": "æ¯æ™šå®ˆè­·1åç©å®¶å…æ–¼ç‹¼æ®ºï¼Œä¸å¯é€£çºŒå…©æ™šå®ˆåŒ1äºº"},
            6: {"name": "ç™½ç—´", "team": "å¥½äººé™£ç‡Ÿ", "skill": "è¢«å…¬æŠ•å‡ºå±€æ™‚ç¿»ç‰Œä¸æ­»ï¼Œå¤±å»æŠ•ç¥¨æ¬Š"},
            7: {"name": "é¨å£«", "team": "å¥½äººé™£ç‡Ÿ", "skill": "ç™½å¤©ç™¼è¨€éšæ®µç¿»ç‰Œæ±ºé¬¥1äººï¼Œå°ç‹¼äººå‰‡ç‹¼äººæ­»äº¡ä¸¦å…¥å¤œï¼›å°å¥½äººå‰‡é¨å£«æ­»äº¡"},
            8: {"name": "é€šéˆå¸«", "team": "å¥½äººé™£ç‡Ÿ", "skill": "æ¯æ™šæŸ¥é©—1åå­˜æ´»ç©å®¶çš„çœŸå¯¦èº«ä»½"},
            9: {"name": "çµé­”äºº", "team": "å¥½äººé™£ç‡Ÿ", "skill": "ç¬¬äºŒæ™šé–‹å§‹ç‹©çµ1äººï¼Œçµç‹¼äººå‰‡ç›®æ¨™æ­»ï¼›çµå¥½äººå‰‡è‡ªèº«æ­»ï¼Œå¥³å·«æ¯’è—¥ç„¡æ•ˆ"},
            10: {"name": "é­”è¡“å¸«", "team": "å¥½äººé™£ç‡Ÿ", "skill": "æ¯æ™šäº¤æ›2äººè™Ÿç¢¼ç‰Œï¼Œç•¶æ™šæŠ€èƒ½äº’æ›ï¼›æ¯è™Ÿåƒ…èƒ½äº¤æ›1æ¬¡ï¼Œå¤©äº®å¾©åŸ"},
            11: {"name": "æ”å¤¢äºº", "team": "å¥½äººé™£ç‡Ÿ", "skill": "æ¯æ™šå¿…é ˆå‚¬çœ 1äººå…å‚·å®³ï¼Œé€£çºŒå…©æ™šå‚¬çœ åŒ1äººå‰‡å…¶æ­»äº¡ï¼›è‡ªèº«æ­»äº¡å‰‡ç›®æ¨™æ®‰æƒ…ï¼Œç„¡æ³•å…ç–«æ®‰æƒ…/ç‹©çµå¤±æ•—æ­»äº¡"},
            12: {"name": "å®ˆå¢“äºº", "team": "å¥½äººé™£ç‡Ÿ", "skill": "æ¯æ™šå¾—çŸ¥å‰ä¸€å¤©è¢«å…¬æŠ•å‡ºå±€ç©å®¶çš„é™£ç‡Ÿ"},
            13: {"name": "æ„›ç¥", "team": "å¥½äººé™£ç‡Ÿ", "skill": "æ¯æ™šå¯é€£çµ2äººç‚ºæƒ…ä¾¶ï¼Œä¸€æ–¹æ­»äº¡å‰‡å¦ä¸€æ–¹æ®‰æƒ…ä¸¦å°å°æŠ€èƒ½ï¼Œæ¯å…©æ™šå¿…é ˆé€£çµä¸€æ¬¡"},
            14: {"name": "ç‹ç‹¸", "team": "å¥½äººé™£ç‡Ÿ", "skill": "æ‰€æœ‰é©—èº«ä»½è§’è‰²æŸ¥é©—çš†é¡¯ç¤ºå¥½äººï¼Œå¤œè£¡èˆ‡ç‹¼äººä¸€èµ·çœçœ¼ï¼Œå±¬æ–¼å¥½äººé™£ç‡Ÿ"},
            15: {"name": "å°ç‹¼", "team": "ç‹¼äººé™£ç‡Ÿ", "skill": "æ¯æ™šåƒèˆ‡åˆ€äººï¼Œç™½å¤©å¯è‡ªçˆ†å¼·åˆ¶å…¥å¤œ"},
            16: {"name": "ç‹¼ç‹", "team": "ç‹¼äººé™£ç‡Ÿ", "skill": "æ­»äº¡/è‡ªçˆ†æ™‚å¯å’¬æ­»1ä½ç©å®¶ã€ç„¡é™åˆ¶ã€‘"},
            17: {"name": "ç‹¼ç¾äºº", "team": "ç‹¼äººé™£ç‡Ÿ", "skill": "æ¯æ™šé­…æƒ‘1äººï¼Œè‡ªèº«æ­»äº¡å‰‡ç›®æ¨™æ®‰æƒ…ï¼›ä¸èƒ½è‡ªåˆ€ã€ä¸èƒ½è‡ªçˆ†"},
            18: {"name": "é›ªç‹¼", "team": "ç‹¼äººé™£ç‡Ÿ", "skill": "é è¨€å®¶/å®ˆå¢“äººæŸ¥é©—çš†é¡¯ç¤ºå¥½äººï¼Œéš±è—ç‹¼äººèº«ä»½"},
            19: {"name": "ç™½ç‹¼ç‹", "team": "ç‹¼äººé™£ç‡Ÿ", "skill": "åƒ…è‡ªçˆ†æ™‚å¯å’¬æ­»1ä½ç©å®¶ï¼Œè¢«æ®º/è¢«æŠ•ç„¡æ³•ç™¼å‹•"},
            20: {"name": "é»‘ç‹¼ç‹", "team": "ç‹¼äººé™£ç‡Ÿ", "skill": "è¢«æŠ•ç¥¨/è¢«æ®ºæ­»äº¡æ™‚å¯å’¬æ­»1ä½ç©å®¶ï¼Œè‡ªçˆ†ç„¡æ³•ç™¼å‹•"},
            21: {"name": "æƒ¡éˆé¨å£«", "team": "ç‹¼äººé™£ç‡Ÿ", "skill": "å¤œæ™šä¸æœƒæ­»äº¡ï¼Œè¢«å®ˆè¡›å¤–ç¥è·æŒ‡å®šå‰‡åæ®ºç¥è·ï¼›ä¸èƒ½è‡ªåˆ€"},
            22: {"name": "çŸ³åƒé¬¼", "team": "ç‹¼äººé™£ç‡Ÿ", "skill": "å–®ç¨çœçœ¼é©—èº«ä»½ï¼Œæ‰€æœ‰ç‹¼äººæ»…çµ•å¾Œå¯å–®ç¨åˆ€äººï¼Œä¸èƒ½è‡ªçˆ†"},
            23: {"name": "è¡€æœˆä½¿è€…", "team": "ç‹¼äººé™£ç‡Ÿ", "skill": "è‡ªçˆ†å¾Œå°å°ç•¶æ™šå¥½äººæŠ€èƒ½ï¼Œæœ€å¾Œç‹¼äººæ™‚è¢«æŠ•ä¸æ­»"},
            24: {"name": "ç‹¼å…„", "team": "ç‹¼äººé™£ç‡Ÿ", "skill": "è‡ªèº«æ­»äº¡å¾Œç‹¼å¼Ÿè¦ºé†’ç²å¾—åˆ€äººèƒ½åŠ›ï¼›ä¸èƒ½è‡ªåˆ€"},
            25: {"name": "ç‹¼å¼Ÿ", "team": "ç‹¼äººé™£ç‡Ÿ", "skill": "ç‹¼å…„æ­»å‰é é©—ç‚ºå¥½äººï¼Œè¦ºé†’å¾Œå…ˆå–®ç¨åˆ€äººå†è·Ÿç‹¼äººé›†é«”åˆ€äººï¼Œç‹¼äººæ»…çµ•å¾Œå¯å–®ç¨åˆ€äºº"}
        };
        const ROLE_LIST = Object.values(ROLES).map(v => v.name);

        // ========== éŠæˆ²æ ¸å¿ƒé¡ ==========
        class WerewolfGame {
            constructor() {
                this.player_num = 0;
                this.custom_role_list = [];
                this.players = {};
                this.wolfs = [];
                this.good_guys = [];
                this.day = 1;
                this.witch_antidote = true;
                this.witch_poison = true;
                this.guard_last_target = -1;
                this.magician_swapped = [];
                this.dreamer_last_target = -1;
                this.grave_last_vote_role = "";
                this.cupid_couple = [];
                this.game_over = false;
                this.winner = "";
                this.wolf_bro_awake = false;
                this.first_game = true;
                this.evil_knight_counter = true;
                this.wolf_young_kill = null;
                this.magician_swap_pair = [];

                // DOMå…ƒç´ 
                this.logEl = document.getElementById('gameLog');
                this.inputEl = document.getElementById('gameInput');
                this.btnEl = document.getElementById('submitBtn');
                this.awaitInput = false;
                this.inputCallback = null;

                // ç¶å®šæŒ‰éˆ•äº‹ä»¶
                this.btnEl.addEventListener('click', () => this.handleInput());
                this.inputEl.addEventListener('keypress', (e) => e.key === 'Enter' && this.handleInput());
            }

            // åˆ—å°æ—¥èªŒåˆ°ç•«é¢
            log(text, className = "") {
                const div = document.createElement('div');
                div.className = className;
                div.textContent = text;
                this.logEl.appendChild(div);
                this.logEl.scrollTop = this.logEl.scrollHeight;
            }

            // ç­‰å¾…ç©å®¶è¼¸å…¥
            async waitForInput() {
                return new Promise(resolve => {
                    this.awaitInput = true;
                    this.inputCallback = resolve;
                    this.inputEl.focus();
                });
            }

            // è™•ç†ç©å®¶è¼¸å…¥
            handleInput() {
                if (!this.awaitInput || !this.inputCallback) return;
                const val = this.inputEl.value.trim();
                this.inputEl.value = "";
                this.awaitInput = false;
                this.inputCallback(val);
            }

            // å­˜æ´»ç©å®¶ç¯©é¸
            get_alive_players() {
                return Object.keys(this.players).map(Number).filter(p => this.players[p].alive);
            }

            // å­˜æ´»ç‹¼äººç¯©é¸
            get_alive_wolfs() {
                return this.wolfs.filter(w => this.players[w].alive);
            }

            // å­˜æ´»å¥½äººç¯©é¸
            get_alive_good() {
                return this.good_guys.filter(g => this.players[g].alive);
            }

            // é€éè§’è‰²åç²å–è§’è‰²ID
            getRoleId(roleName) {
                return Object.keys(ROLES).find(k => ROLES[k].name === roleName);
            }

            // é€éè§’è‰²åç²å–é™£ç‡Ÿ
            getRoleTeam(roleName) {
                return ROLES[this.getRoleId(roleName)].team;
            }

            // ========== âœ… ç¬¬ä¸€æ¬¡é–‹å±€ï¼šæ‰‹å‹•è¨­å®šæœ¬å±€çš„è§’è‰²æ¸…å–® (åªåŸ·è¡Œ1æ¬¡ï¼Œé‡é–‹è§’è‰²ä¸è®Š) âœ…
            async manual_role_setup() {
                this.log("======= ğŸº ç‹¼äººæ®ºã€æ‰‹å‹•æŒ‡å®šè§’è‰²æ¨¡å¼ã€‘ğŸº =======");
                this.log("ã€è¦å‰‡ã€‘å®Œå…¨æ‰‹å‹•è¨­å®šæœ¬å±€è§’è‰²æ¸…å–®ï¼Œã€ç¬¬Nå€‹è¼¸å…¥çš„è§’è‰² = Nè™Ÿç©å®¶ã€‘ï¼Œå›ºå®šé †åºæ°¸ä¸äº‚åºï¼");
                this.log("\n======= ğŸ“œ æ‰€æœ‰å¯é¸æ“‡çš„è§’è‰²å°æ‡‰è¡¨ã€å¥½äºº/ç‹¼äººæ¸…æ™°æ¨™è¨»ã€‘ =======");
                for (let idx in ROLES) {
                    const info = ROLES[idx];
                    const team_tag = info.team === "å¥½äººé™£ç‡Ÿ" ? "ğŸŸ¢å¥½äºº" : "ğŸ”´ç‹¼äºº";
                    this.log(`${idx}. ${team_tag} ${info.name} - æŠ€èƒ½ï¼š${info.skill}`);
                }

                // ç¬¬ä¸€æ­¥ï¼šæ‰‹å‹•è¨­å®šæœ¬å±€ç©å®¶ç¸½äººæ•¸
                while (true) {
                    this.log("\nè«‹è¼¸å…¥æœ¬å±€çš„ç©å®¶ç¸½äººæ•¸ (æ•¸å­—å³å¯ï¼Œç„¡é™åˆ¶)ï¼š");
                    const input = await this.waitForInput();
                    const num = parseInt(input);
                    if (!isNaN(num) && num >= 1) {
                        this.player_num = num;
                        this.log(`âœ… è¨­å®šå®Œæˆï¼æœ¬å±€å…± ${this.player_num} ä½ç©å®¶ï¼Œç·¨è™Ÿï¼š1 ~ ${this.player_num}`, "success");
                        break;
                    } else {
                        this.log("äººæ•¸å¿…é ˆå¤§æ–¼ç­‰æ–¼1ï¼è«‹é‡æ–°è¼¸å…¥ï¼", "danger");
                    }
                }

                // ç¬¬äºŒæ­¥ï¼šé€å€‹è¨­å®šæœ¬å±€çš„è§’è‰²æ¸…å–®
                this.log("\n======= é–‹å§‹æ‰‹å‹•æŒ‡å®šæœ¬å±€è§’è‰²æ¸…å–® =======");
                this.log(`ã€é‡é»è¦å‰‡ã€‘ä½ è¼¸å…¥çš„ç¬¬1å€‹è§’è‰² â†’ 1è™Ÿç©å®¶ï¼Œç¬¬2å€‹è§’è‰² â†’ 2è™Ÿç©å®¶ï¼Œä¾æ­¤é¡æ¨ï¼`);
                const temp_role_list = [];
                for (let player_id = 1; player_id <= this.player_num; player_id++) {
                    while (true) {
                        this.log(`\nè«‹è¨­å®šã€${player_id}è™Ÿç©å®¶ã€‘çš„è§’è‰²é¡å‹ (è¼¸å…¥è§’è‰²æ•¸å­—)ï¼š`);
                        const input = await this.waitForInput();
                        const role_idx = parseInt(input);
                        if (!isNaN(role_idx) && role_idx >=1 && role_idx <= Object.keys(ROLES).length) {
                            const role_name = ROLES[role_idx].name;
                            const team_tag = ROLES[role_idx].team === "å¥½äººé™£ç‡Ÿ" ? "ğŸŸ¢å¥½äºº" : "ğŸ”´ç‹¼äºº";
                            temp_role_list.push(role_name);
                            this.log(`âœ… ${player_id}è™Ÿç©å®¶ ç¢ºå®šè§’è‰²ï¼š${team_tag}ã€${role_name}ã€‘`, "success");
                            break;
                        } else {
                            this.log(`è¼¸å…¥éŒ¯èª¤ï¼è«‹è¼¸å…¥ 1 ~ ${Object.keys(ROLES).length} ä¹‹é–“çš„æ•¸å­—ï¼`, "danger");
                        }
                    }
                }

                // é©—è­‰é…ç½®åˆç†æ€§
                if (temp_role_list.length <4) {
                    this.log("ç¸½äººæ•¸ä¸èƒ½å°‘æ–¼4äººï¼è«‹é‡æ–°é…ç½®ï¼", "danger");
                    await this.manual_role_setup();
                    return;
                }

                this.custom_role_list = temp_role_list;
                this.log(`\nâœ… è§’è‰²æ¸…å–®è¨­å®šå®Œæˆï¼æœ¬å±€ç©å®¶è§’è‰²å°æ‡‰è¡¨ï¼š`, "success");
                for (let i=0; i<this.custom_role_list.length; i++) {
                    this.log(`   ${i+1}è™Ÿç©å®¶ â†’ ${this.custom_role_list[i]}`);
                }
                await this.sleep(3000);
            }

            // ========== âœ… æ ¸å¿ƒæ–°å¢ï¼šé‡é–‹éŠæˆ²å°ˆç”¨ - æ‰‹å‹•è‡ªé¸è§’è‰²åˆ†é… âœ…
            async manual_assign_roles() {
                this.log("\n======= ğŸ® é‡æ–°é–‹å±€ Â· æ‰‹å‹•åˆ†é…è§’è‰² ğŸ® =======");
                this.log(`ã€è¦å‰‡ã€‘åªèƒ½é¸æ“‡æœ¬å±€å›ºå®šè§’è‰²æ¸…å–®å…§çš„è§’è‰²ï¼Œæ•¸é‡ä¸è®Šï¼Œå¯è‡ªç”±åˆ†é…çµ¦ä»»æ„ç©å®¶ï¼`);
                this.log(`æœ¬å±€å›ºå®šè§’è‰²æ¸…å–®ï¼š${this.custom_role_list}`);
                this.log(`æœ¬å±€ç©å®¶ç·¨è™Ÿï¼š${Array.from({length:this.player_num}, (_,i)=>i+1)}`);
                await this.sleep(1000);

                const assign_role_pool = [...this.custom_role_list];
                const assign_players = {};

                for (let player_id=1; player_id<=this.player_num; player_id++) {
                    while (true) {
                        this.log(`\nğŸ“Œ ç•¶å‰å¾…åˆ†é…è§’è‰²å‰©é¤˜ï¼š${assign_role_pool}`);
                        this.log(`ğŸ‘‰ è«‹ç‚ºã€${player_id}è™Ÿç©å®¶ã€‘åˆ†é…è§’è‰²ï¼š`);
                        assign_role_pool.forEach((role, idx) => {
                            const team_tag = this.getRoleTeam(role) === "å¥½äººé™£ç‡Ÿ" ? "ğŸŸ¢å¥½äºº" : "ğŸ”´ç‹¼äºº";
                            this.log(`   ${idx+1}. ${team_tag} ${role}`);
                        });
                        const input = await this.waitForInput();
                        const select_idx = parseInt(input);
                        if (!isNaN(select_idx) && select_idx >=1 && select_idx <= assign_role_pool.length) {
                            const selected_role = assign_role_pool.splice(select_idx-1,1)[0];
                            assign_players[player_id] = selected_role;
                            const team_tag = this.getRoleTeam(selected_role) === "å¥½äººé™£ç‡Ÿ" ? "ğŸŸ¢å¥½äºº" : "ğŸ”´ç‹¼äºº";
                            this.log(`âœ… ${player_id}è™Ÿç©å®¶ åˆ†é…åˆ°è§’è‰²ï¼š${team_tag}ã€${selected_role}ã€‘`, "success");
                            break;
                        } else {
                            this.log(`è¼¸å…¥éŒ¯èª¤ï¼è«‹è¼¸å…¥ 1-${assign_role_pool.length} ä¹‹é–“çš„æ•¸å­—ï¼`, "danger");
                        }
                    }
                }
                return assign_players;
            }

            // ========== âœ… åˆå§‹åŒ–éŠæˆ² (âœ…æ ¸å¿ƒä¿®æ”¹ï¼šç¬¬ä¸€æ¬¡å›ºå®šé †åºåˆ†é…ï¼Œé‡é–‹æ‰‹å‹•åˆ†é… + ç‹€æ…‹å…¨é‡ç½®) âœ…
            async init_game() {
                // é‡ç½®æ‰€æœ‰éŠæˆ²ç‹€æ…‹
                this.players = {};
                this.wolfs = [];
                this.good_guys = [];
                this.day = 1;
                this.witch_antidote = true;
                this.witch_poison = true;
                this.guard_last_target = -1;
                this.magician_swapped = [];
                this.dreamer_last_target = -1;
                this.grave_last_vote_role = "";
                this.cupid_couple = [];
                this.game_over = false;
                this.winner = "";
                this.wolf_bro_awake = false;
                this.evil_knight_counter = true;
                this.wolf_young_kill = null;
                this.magician_swap_pair = [];

                this.log("\n======= ğŸº æ­¡è¿ä¾†åˆ°è¶…å®Œæ•´ç‰ˆç‹¼äººæ®ºéŠæˆ² ğŸº =======");
                this.log(`å¤©é»‘è«‹é–‰çœ¼ï¼éŠæˆ²å³å°‡é–‹å§‹ï¼ç•¶å‰ç‚ºç¬¬${this.day}å¤©`);
                this.log(`ã€éŠæˆ²è¦å‰‡ã€‘æ—¥å¤œç„¡é™å¾ªç’°ï¼Œç›´åˆ°ä¸€æ–¹é™£ç‡Ÿå…¨æ»…ç‚ºæ­¢ï¼`);
                this.log(`ã€å¿«æ·è¦å‰‡ã€‘æ‰€æœ‰æŠ€èƒ½è¼¸0è·³éã€æŠ•ç¥¨è¼¸0è§¸ç™¼ç‹¼äººè‡ªçˆ†ã€ç‹¼äººå¯åˆ€è‡ªå·±äºº`);
                this.log(`ã€é™£ç‡Ÿè¦å‰‡ã€‘ğŸŸ¢å¥½äººé™£ç‡Ÿï¼šå± æ»…æ‰€æœ‰ç‹¼äººç²å‹ | ğŸ”´ç‹¼äººé™£ç‡Ÿï¼šå± æ»…æ‰€æœ‰å¥½äººç²å‹`);
                await this.sleep(2000);

                // ç¬¬ä¸€æ¬¡é–‹å±€ï¼šå›ºå®šé †åºåˆ†é…
                if (this.first_game) {
                    const temp_role = [...this.custom_role_list];
                    for (let i=1; i<=this.player_num; i++) {
                        const role = temp_role[i-1];
                        this.players[i] = { role, alive: true, can_vote: true, skill_lock: false };
                    }
                    this.first_game = false;
                } else {
                    // é‡é–‹éŠæˆ²ï¼šæ‰‹å‹•åˆ†é…
                    const assign_players = await this.manual_assign_roles();
                    for (let pid in assign_players) {
                        const player_id = parseInt(pid);
                        this.players[player_id] = { role: assign_players[player_id], alive: true, can_vote: true, skill_lock: false };
                    }
                }

                // é‡æ–°åˆ†é™£ç‡Ÿ
                for (let p_id in this.players) {
                    const pid = parseInt(p_id);
                    const role = this.players[pid].role;
                    if (this.getRoleTeam(role) === "ç‹¼äººé™£ç‡Ÿ") {
                        this.wolfs.push(pid);
                    } else {
                        this.good_guys.push(pid);
                    }
                }

                // é™£ç‡Ÿå…¬ç¤º
                this.log(`\nğŸ“Š æœ¬å±€é™£ç‡Ÿåˆ†é…ï¼š`);
                this.log(`ğŸŸ¢ å¥½äººé™£ç‡Ÿç©å®¶ç·¨è™Ÿï¼š${this.good_guys}`, "good");
                this.log(`ğŸ”´ ç‹¼äººé™£ç‡Ÿç©å®¶ç·¨è™Ÿï¼š${this.wolfs}`, "wolf");
                await this.sleep(2000);
            }

            // ========== âœ… å¤œæ™šè¡Œå‹•éšæ®µ ==========
            async night_action() {
                if (this.game_over) return;
                this.log(`\n======= ç¬¬${this.day}å¤© Â· å¤œæ™š =======`);
                const alive_players = this.get_alive_players();
                const alive_wolfs = this.get_alive_wolfs();
                const alive_good = this.get_alive_good();
                let kill_target = null;
                const real_dead = [];
                let wolf_bite = null;
                const anti_kill_list = [];
                let dreamer_dead = false;

                // ç‹¼å¼Ÿè¦ºé†’åˆ¤å®š
                const wolf_bro = Object.keys(this.players).map(Number).filter(p => this.players[p].role === "ç‹¼å…„" && !this.players[p].alive);
                const wolf_young = Object.keys(this.players).map(Number).filter(p => this.players[p].role === "ç‹¼å¼Ÿ" && this.players[p].alive);
                if (wolf_bro.length && wolf_young.length && !this.wolf_bro_awake) {
                    this.wolf_bro_awake = true;
                    this.log(`\nâš ï¸  ã€ç‹¼å¼Ÿè¦ºé†’è¦å‰‡ã€‘ç‹¼å…„å·²æ­»äº¡ï¼Œç‹¼å¼Ÿæ­£å¼è¦ºé†’ï¼é é©—å¥½äººæ•ˆæœæ¶ˆå¤±ï¼`, "warn");
                    this.log(`âš ï¸  ç‹¼å¼Ÿè¦ºé†’å¾Œ â†’ å¤œæ™šå„ªå…ˆæ‰€æœ‰ç‹¼äººï¼Œå…ˆå–®ç¨åˆ€1äººï¼Œéš¨å¾ŒåŠ å…¥ç‹¼äººé›†é«”åˆ€äººï¼`, "warn");
                    this.log(`âš ï¸  ç‹¼å¼Ÿé¡å¤–è¦å‰‡ï¼šç‹¼äººåœ˜æ»…å¾Œï¼Œç‹¼å¼Ÿå¯å–®ç¨åŸ·è¡Œåˆ€äººè¡Œå‹•ï¼`, "warn");
                    await this.sleep(2000);
                }

                // ç‹ç‹¸è¦å‰‡
                const fox = Object.keys(this.players).map(Number).filter(p => this.players[p].role === "ç‹ç‹¸" && this.players[p].alive);
                if (fox.length && alive_wolfs.length) {
                    this.log(`\nğŸ¦Š ã€ç‹ç‹¸è¦å‰‡ã€‘${fox[0]}è™Ÿç‹ç‹¸ å±¬æ–¼å¥½äººï¼Œä½†ä»Šå¤œèˆ‡ç‹¼äººä¸€èµ·çœçœ¼ï¼`);
                    await this.sleep(1000);
                }

                // ç‹¼å¼Ÿå–®ç¨åˆ€äºº
                if (this.wolf_bro_awake && wolf_young.length) {
                    const wy_id = wolf_young[0];
                    this.log(`\nğŸº ç‹¼å¼Ÿ(${wy_id}è™Ÿ)å–®ç¨çœçœ¼ï¼è¦ºé†’å¾Œå„ªå…ˆåˆ€äººï¼Œè¼¸0è·³éæœ¬æ¬¡å–®ç¨åˆ€äºº`);
                    while (true) {
                        const input = await this.waitForInput();
                        const wy_kill = parseInt(input);
                        if (wy_kill === 0) {
                            this.log("âœ… ç‹¼å¼Ÿé¸æ“‡è·³éå–®ç¨åˆ€äººï¼Œç­‰å¾…ç‹¼äººé›†é«”è¡Œå‹•", "success");
                            this.wolf_young_kill = null;
                            break;
                        }
                        if (alive_players.includes(wy_kill)) {
                            this.wolf_young_kill = wy_kill;
                            this.log(`âœ… ç‹¼å¼Ÿå–®ç¨åˆ€æ®º ${wy_kill}è™Ÿç©å®¶ï¼`, "success");
                            break;
                        }
                        this.log("è¼¸å…¥éŒ¯èª¤ï¼è«‹é¸æ“‡å­˜æ´»çš„ç©å®¶ç·¨è™Ÿï¼", "danger");
                    }
                    await this.sleep(1000);
                }

                // 1. é­”è¡“å¸«è¡Œå‹•
                const magician = Object.keys(this.players).map(Number).filter(p => this.players[p].role === "é­”è¡“å¸«" && this.players[p].alive && !this.players[p].skill_lock);
                if (magician.length) {
                    this.log(`\nğŸª„ é­”è¡“å¸«(${magician[0]}è™Ÿ)çœçœ¼ï¼å¯äº¤æ›2äººè™Ÿç¢¼ç‰Œã€åƒ…ç•¶æ™šæœ‰æ•ˆã€‘ï¼Œè¼¸0è·³éï¼Œå·²äº¤æ›:${this.magician_swapped}`);
                    while (true) {
                        const input = await this.waitForInput();
                        if (input === "0") {
                            this.log("âœ… é­”è¡“å¸«é¸æ“‡è·³éæŠ€èƒ½ï¼Œä¸äº¤æ›ä»»ä½•äºº", "success");
                            break;
                        }
                        const [swap1, swap2] = input.split(" ").map(Number);
                        if (alive_players.includes(swap1) && alive_players.includes(swap2) && swap1 !== swap2) {
                            if (!this.magician_swapped.includes(swap1) && !this.magician_swapped.includes(swap2)) {
                                this.magician_swapped.push(swap1, swap2);
                                this.magician_swap_pair = [swap1, swap2];
                                [this.players[swap1].role, this.players[swap2].role] = [this.players[swap2].role, this.players[swap1].role];
                                this.log(`âœ… æˆåŠŸäº¤æ› ${swap1}è™Ÿ èˆ‡ ${swap2}è™Ÿ èº«åˆ†èˆ‡æŠ€èƒ½ï¼ã€æ•ˆæœåƒ…ç•¶æ™šæœ‰æ•ˆï¼Œå¤©äº®è‡ªå‹•å¾©åŸã€‘`, "success");
                                break;
                            } else {
                                this.log("å…¶ä¸­ä¸€å€‹è™Ÿç¢¼å·²è¢«äº¤æ›éï¼æ¯è™Ÿåƒ…èƒ½äº¤æ›1æ¬¡", "danger");
                            }
                        } else {
                            this.log("è¼¸å…¥éŒ¯èª¤ï¼è«‹é¸æ“‡å­˜æ´»ä¸”ä¸åŒçš„ç©å®¶", "danger");
                        }
                    }
                    await this.sleep(1000);
                }

                // 2. ç‹¼äººé›†é«”åˆ€äºº
                if (alive_wolfs.length >=1) {
                    this.log(`\nğŸº ç‹¼äººé™£ç‡Ÿçœçœ¼ï¼å­˜æ´»ç‹¼äººï¼š${alive_wolfs}ï¼Œå­˜æ´»ç©å®¶ï¼š${alive_players}`);
                    this.log(`ã€è¦å‰‡ã€‘ç‹¼äººå¯åˆ€ä»»ä½•äºº(åŒ…å«è‡ªå·±/ç‹¼äººåŒä¼´/å¥½äººï¼Œå®Œå…¨ç„¡é™åˆ¶)ï¼Œè¼¸0=ä¸åˆ€äººè·³é`);
                    while (true) {
                        const input = await this.waitForInput();
                        kill_target = parseInt(input);
                        if (kill_target === 0) {
                            this.log("âœ… ç‹¼äººé¸æ“‡è·³éåˆ€äººï¼Œå¹³å®‰å¤œ", "success");
                            wolf_bite = null;
                            break;
                        }
                        if (alive_players.includes(kill_target)) {
                            if (this.players[kill_target].role === "æƒ¡éˆé¨å£«") {
                                this.log("âŒ æƒ¡éˆé¨å£«è¦å‰‡ï¼šç¦æ­¢è‡ªåˆ€ï¼è«‹é‡æ–°é¸æ“‡ç›®æ¨™", "danger");
                                continue;
                            }
                            wolf_bite = kill_target;
                            this.log(`âœ… ç‹¼äººé¸æ“‡æ“Šæ®º ${kill_target}è™Ÿç©å®¶ï¼`, "success");
                            break;
                        }
                        this.log("è¼¸å…¥éŒ¯èª¤ï¼è«‹é¸æ“‡å­˜æ´»çš„ç©å®¶ç·¨è™Ÿï¼", "danger");
                    }
                }

                // 3. å®ˆè¡›è¡Œå‹•
                const guard = Object.keys(this.players).map(Number).filter(p => this.players[p].role === "å®ˆè¡›" && this.players[p].alive && !this.players[p].skill_lock);
                let guard_target = -1;
                if (guard.length) {
                    this.log(`\nğŸ›¡ï¸  å®ˆè¡›(${guard[0]}è™Ÿ)çœçœ¼ï¼ä¸Šä¸€æ™šå®ˆè­·:${this.guard_last_target} (ä¸å¯é€£å®ˆåŒä¸€äºº)ï¼Œè¼¸0è·³éæŠ€èƒ½`);
                    while (true) {
                        const input = await this.waitForInput();
                        guard_target = parseInt(input);
                        if (guard_target === 0) {
                            this.log("âœ… å®ˆè¡›é¸æ“‡è·³éæŠ€èƒ½ï¼Œä¸å®ˆè­·ä»»ä½•äºº", "success");
                            guard_target = -1;
                            break;
                        }
                        if (alive_players.includes(guard_target) && guard_target !== this.guard_last_target) {
                            this.guard_last_target = guard_target;
                            this.log(`âœ… å®ˆè¡›é¸æ“‡å®ˆè­· ${guard_target}è™Ÿ ç©å®¶`, "success");
                            break;
                        }
                        this.log(`ä¸å¯å®ˆè­·ä¸Šä¸€æ™šç›®æ¨™(${this.guard_last_target})æˆ–æ­»äº¡ç©å®¶ï¼`, "danger");
                    }
                    await this.sleep(1000);
                }

                // 4. æ”å¤¢äººè¡Œå‹•
                const dreamer = Object.keys(this.players).map(Number).filter(p => this.players[p].role === "æ”å¤¢äºº" && this.players[p].alive && !this.players[p].skill_lock);
                let dream_target = -1;
                if (dreamer.length) {
                    const dr_id = dreamer[0];
                    this.log(`\nğŸ’¤ æ”å¤¢äºº(${dr_id}è™Ÿ)çœçœ¼ï¼ã€å¼·åˆ¶è¦å‰‡ã€‘å¿…é ˆå‚¬çœ 1åéè‡ªå·±çš„å­˜æ´»ç©å®¶ï¼Œç„¡è·³éé¸é …ï¼`);
                    this.log(`ä¸Šä¸€æ™šå‚¬çœ ç›®æ¨™ï¼š${this.dreamer_last_target} | é€£çºŒå‚¬çœ åŒä¸€äººæœƒç›´æ¥æ­»äº¡ï¼`);
                    this.log(`ã€è±å…è¦å‰‡ã€‘å‚¬çœ ç›®æ¨™å…ç–«å¤œå‚·å®³ï¼Œä½†ç„¡æ³•å…ç–«æ®‰æƒ…ã€ç‹©çµå¤±æ•—è‡ªæ®ºï¼`);
                    while (true) {
                        const input = await this.waitForInput();
                        dream_target = parseInt(input);
                        if (alive_players.includes(dream_target) && dream_target !== dr_id) {
                            if (dream_target === this.dreamer_last_target) {
                                this.log(`âš ï¸  æ”å¤¢äººè¦å‰‡ï¼š${dream_target}è™Ÿè¢«é€£çºŒå…©æ™šå‚¬çœ ï¼ç›´æ¥æ­»äº¡+æŠ€èƒ½å°å°ï¼`, "warn");
                                real_dead.push(dream_target);
                                this.players[dream_target].skill_lock = true;
                            }
                            this.dreamer_last_target = dream_target;
                            this.log(`âœ… å‚¬çœ  ${dream_target}è™Ÿï¼Œç›®æ¨™å…ç–«å¤œé–“æ‰€æœ‰å¤–ä¾†å‚·å®³ï¼`, "success");
                            break;
                        }
                        this.log("è«‹é¸æ“‡å­˜æ´»ä¸”éè‡ªå·±çš„ç©å®¶ï¼ç„¡è·³éé¸é …ï¼", "danger");
                    }
                    await this.sleep(1000);
                }

                // 5. é è¨€å®¶æŸ¥é©—
                const prophet = Object.keys(this.players).map(Number).filter(p => this.players[p].role === "é è¨€å®¶" && this.players[p].alive && !this.players[p].skill_lock);
                if (prophet.length) {
                    this.log(`\nğŸ”® é è¨€å®¶(${prophet[0]}è™Ÿ)çœçœ¼ï¼å­˜æ´»ç©å®¶ï¼š${alive_players}ï¼Œè¼¸0è·³éæŠ€èƒ½`);
                    while (true) {
                        const input = await this.waitForInput();
                        const check_target = parseInt(input);
                        if (check_target === 0) {
                            this.log("âœ… é è¨€å®¶é¸æ“‡è·³éæŠ€èƒ½ï¼Œä¸æŸ¥é©—ä»»ä½•äºº", "success");
                            break;
                        }
                        if (alive_players.includes(check_target)) {
                            const tar_role = this.players[check_target].role;
                            let res = "";
                            if (["é›ªç‹¼", "ç‹ç‹¸"].includes(tar_role) || (tar_role === "ç‹¼å¼Ÿ" && !this.wolf_bro_awake)) {
                                res = "å¥½äººâœ…";
                            } else if (parseInt(this.getRoleId(tar_role)) <=14) {
                                res = "å¥½äººâœ…";
                            } else {
                                res = "å£äººâŒ";
                                if (tar_role === "æƒ¡éˆé¨å£«" && this.evil_knight_counter) anti_kill_list.push(prophet[0]);
                            }
                            this.log(`âœ… æŸ¥é©—çµæœï¼š${check_target}è™Ÿç©å®¶æ˜¯ ${res}`, "success");
                            break;
                        }
                    }
                }
                await this.sleep(1000);

                // 6. é€šéˆå¸«æŸ¥é©—
                const medium = Object.keys(this.players).map(Number).filter(p => this.players[p].role === "é€šéˆå¸«" && this.players[p].alive && !this.players[p].skill_lock);
                if (medium.length) {
                    this.log(`\nğŸ”® é€šéˆå¸«(${medium[0]}è™Ÿ)çœçœ¼ï¼å­˜æ´»ç©å®¶ï¼š${alive_players}ï¼Œè¼¸0è·³éæŠ€èƒ½`);
                    while (true) {
                        const input = await this.waitForInput();
                        const check_target = parseInt(input);
                        if (check_target ===0) {
                            this.log("âœ… é€šéˆå¸«é¸æ“‡è·³éæŠ€èƒ½ï¼Œä¸æŸ¥é©—ä»»ä½•äºº", "success");
                            break;
                        }
                        if (alive_players.includes(check_target)) {
                            this.log(`âœ… æŸ¥é©—çµæœï¼š${check_target}è™Ÿç©å®¶çœŸå¯¦èº«åˆ†æ˜¯ã€${this.players[check_target].role}ã€‘`, "success");
                            break;
                        }
                    }
                }
                await this.sleep(1000);

                // 7. å¥³å·«å®Œæ•´è¦å‰‡
                const witch = Object.keys(this.players).map(Number).filter(p => this.players[p].role === "å¥³å·«" && this.players[p].alive && !this.players[p].skill_lock);
                if (witch.length && wolf_bite) {
                    const witch_id = witch[0];
                    this.log(`\nğŸ§ª å¥³å·«(${witch_id}è™Ÿ)çœçœ¼ï¼ä»Šå¤œç‹¼äººåˆ€æ®ºï¼š${wolf_bite}è™Ÿ`);
                    this.log(`ç‹€æ…‹ï¼šè§£è—¥${this.witch_antidote ? 'å¯ç”¨' : 'ç”¨å®Œ'} | æ¯’è—¥${this.witch_poison ? 'å¯ç”¨' : 'ç”¨å®Œ'}`);
                    this.log("è«‹é¸æ“‡è¡Œå‹•ï¼š1-æ•‘ä»–  2-æ¯’åˆ¥äºº  0-è·³éä¸ç”¨è—¥ (è¼¸å…¥æ•¸å­—)ï¼š");
                    let choice = "";
                    while (true) {
                        choice = await this.waitForInput();
                        if (["0","1","2"].includes(choice)) break;
                        this.log("è¼¸å…¥éŒ¯èª¤ï¼è«‹è¼¸å…¥0/1/2ï¼", "danger");
                    }

                    if (choice === "0") {
                        this.log("âœ… å¥³å·«é¸æ“‡è·³éæŠ€èƒ½ï¼Œéƒ½ä¸ç”¨è—¥", "success");
                    } else if (choice === "1" && this.witch_antidote) {
                        if (this.day ===1 && wolf_bite === witch_id) {
                            this.log("âŒ å¥³å·«è¦å‰‡ï¼šç¬¬ä¸€æ™šçµ•å°ä¸èƒ½è‡ªæ•‘ï¼è§£è—¥ä½¿ç”¨å¤±æ•—", "danger");
                        } else if (wolf_bite === guard_target) {
                            this.log("âŒ æ ¸å¿ƒè¦å‰‡ï¼šå®ˆè¡›å®ˆè­· + å¥³å·«è§£è—¥ åŒæ™‚ç”Ÿæ•ˆ â†’ ç›®æ¨™ä¾ç„¶æ­»äº¡ï¼", "danger");
                        } else {
                            this.witch_antidote = false;
                            wolf_bite = null;
                            this.log("âœ… ä½¿ç”¨è§£è—¥ï¼Œç›®æ¨™è¢«æ•‘æ´»ï¼", "success");
                        }
                    } else if (choice === "2" && this.witch_poison) {
                        this.witch_poison = false;
                        this.log(`\nè«‹é¸æ“‡æ¯’æ®ºç›®æ¨™ (å­˜æ´»ç©å®¶ï¼š${alive_players})ï¼Œè¼¸0è·³éæ¯’è—¥ï¼š`);
                        while (true) {
                            const input = await this.waitForInput();
                            const poison_tar = parseInt(input);
                            if (poison_tar ===0) {
                                this.log("âœ… å¥³å·«é¸æ“‡è·³éæ¯’è—¥æŠ€èƒ½", "success");
                                break;
                            }
                            if (alive_players.includes(poison_tar)) {
                                if (this.players[poison_tar].role === "çµé­”äºº") {
                                    this.log("âœ… çµé­”äººè¦å‰‡ï¼šå®Œå…¨å…ç–«å¥³å·«æ‰€æœ‰æ¯’è—¥ï¼æ¯’æ®ºç„¡æ•ˆã€çµ•å°è¦å‰‡ã€‘", "success");
                                } else {
                                    this.players[poison_tar].skill_lock = true;
                                    real_dead.push(poison_tar);
                                    if (this.players[poison_tar].role === "æƒ¡éˆé¨å£«" && this.evil_knight_counter) anti_kill_list.push(witch_id);
                                    this.log(`âœ… ä½¿ç”¨æ¯’è—¥ï¼Œæ¯’æ®º${poison_tar}è™Ÿç©å®¶+å°å°æŠ€èƒ½ï¼`, "success");
                                }
                                break;
                            }
                        }
                    }
                }
                await this.sleep(1000);

                // 8. çµé­”äººå®Œæ•´è¦å‰‡
                const hunter_mage = Object.keys(this.players).map(Number).filter(p => this.players[p].role === "çµé­”äºº" && this.players[p].alive && !this.players[p].skill_lock);
                if (hunter_mage.length && this.day >=2) {
                    this.log(`\nğŸ¹ çµé­”äºº(${hunter_mage[0]}è™Ÿ)çœçœ¼ï¼ç¬¬äºŒæ™šé–‹å•Ÿç‹©çµèƒ½åŠ›ï¼Œè¼¸0è·³éæŠ€èƒ½`);
                    this.log(`ã€è¦å‰‡ã€‘çµç‹¼äºº=ç›®æ¨™æ­» | çµå¥½äºº=è‡ªå·±æ­» | å®Œå…¨å…ç–«å¥³å·«æ¯’è—¥`);
                    while (true) {
                        const input = await this.waitForInput();
                        const hunt_tar = parseInt(input);
                        if (hunt_tar ===0) {
                            this.log("âœ… çµé­”äººé¸æ“‡è·³éæŠ€èƒ½ï¼Œä¸ç‹©çµä»»ä½•äºº", "success");
                            break;
                        }
                        if (alive_players.includes(hunt_tar)) {
                            const tar_team = this.getRoleTeam(this.players[hunt_tar].role);
                            if (tar_team === "ç‹¼äººé™£ç‡Ÿ") {
                                real_dead.push(hunt_tar);
                                this.log(`âœ… ç‹©çµæˆåŠŸï¼${hunt_tar}è™Ÿç‹¼äººæ­»äº¡`, "success");
                            } else {
                                real_dead.push(hunter_mage[0]);
                                this.log(`âŒ ç‹©çµè¦å‰‡ï¼šç‹©çµå¥½äºº â†’ çµé­”äººè‡ªèº«æ­»äº¡ï¼ç„¡æ³•å…ç–«ï¼`, "danger");
                            }
                            break;
                        }
                    }
                }
                await this.sleep(1000);

                // 9. çŸ³åƒé¬¼å–®ç¨è¡Œå‹•
                const stone_ghost = Object.keys(this.players).map(Number).filter(p => this.players[p].role === "çŸ³åƒé¬¼" && this.players[p].alive && !this.players[p].skill_lock);
                if (stone_ghost.length) {
                    this.log(`\nğŸ‘» çŸ³åƒé¬¼(${stone_ghost[0]}è™Ÿ)å–®ç¨çœçœ¼ï¼ä¸èˆ‡å…¶ä»–ç‹¼äººç¢°é¢ï¼Œè¼¸0è·³éæŠ€èƒ½`);
                    const normal_wolf = alive_wolfs.filter(w => this.players[w].role !== "çŸ³åƒé¬¼");
                    if (normal_wolf.length ===0) {
                        this.log("âš ï¸  çŸ³åƒé¬¼è¦å‰‡ï¼šæ‰€æœ‰æ™®é€šç‹¼äººå·²æ»…çµ•ï¼ŒçŸ³åƒé¬¼ç²å¾—ç¨è‡ªåˆ€äººæ¬Šï¼", "warn");
                        while (true) {
                            const input = await this.waitForInput();
                            const ghost_kill = parseInt(input);
                            if (ghost_kill ===0) {
                                this.log("âœ… çŸ³åƒé¬¼é¸æ“‡è·³éæŠ€èƒ½ï¼Œä¸åˆ€ä»»ä½•äºº", "success");
                                break;
                            }
                            if (alive_players.includes(ghost_kill)) {
                                wolf_bite = ghost_kill;
                                this.log(`âœ… çŸ³åƒé¬¼åˆ€æ®º ${ghost_kill}è™Ÿ`, "success");
                                break;
                            }
                        }
                    } else {
                        while (true) {
                            const input = await this.waitForInput();
                            const check_tar = parseInt(input);
                            if (check_tar ===0) {
                                this.log("âœ… çŸ³åƒé¬¼é¸æ“‡è·³éæŠ€èƒ½ï¼Œä¸æŸ¥é©—ä»»ä½•äºº", "success");
                                break;
                            }
                            this.log(`âœ… æŸ¥é©—çµæœï¼š${check_tar}è™Ÿæ˜¯ã€${this.players[check_tar].role}ã€‘`, "success");
                            break;
                        }
                    }
                }
                await this.sleep(1000);

                // 10. æ„›ç¥ä¿®æ­£è¦å‰‡
                const cupid = Object.keys(this.players).map(Number).filter(p => this.players[p].role === "æ„›ç¥" && this.players[p].alive && !this.players[p].skill_lock);
                if (cupid.length) {
                    this.log(`\nğŸ’˜ æ„›ç¥(${cupid[0]}è™Ÿ)çœçœ¼ï¼ã€è¦å‰‡ã€‘æ¯æ™šå¯é€£çµæƒ…ä¾¶ï¼Œæ¯å…©æ™šå¿…é ˆé€£çµä¸€æ¬¡ï¼Œç„¡è·³éé¸é …ï¼`);
                    this.log(`ã€æƒ…ä¾¶è¦å‰‡ã€‘ä¸€æ–¹æ­»äº¡ï¼Œå¦ä¸€æ–¹ç«‹åˆ»æ®‰æƒ…+æŠ€èƒ½å°å°ï¼`);
                    while (true) {
                        const input = await this.waitForInput();
                        const [c1, c2] = input.split(" ").map(Number);
                        if (alive_players.includes(c1) && alive_players.includes(c2) && c1 !== c2) {
                            this.cupid_couple = [c1, c2];
                            this.log(`âœ… æˆåŠŸé€£çµ ${c1}è™Ÿ èˆ‡ ${c2}è™Ÿ ç‚ºæƒ…ä¾¶ï¼ä¸€æ–¹æ­»äº¡å‰‡å¦ä¸€æ–¹æ®‰æƒ…+å°å°æŠ€èƒ½ï¼`, "success");
                            break;
                        }
                        this.log("æ ¼å¼éŒ¯èª¤ï¼è«‹è¼¸å…¥å…©å€‹å­˜æ´»ç©å®¶æ•¸å­—ç©ºæ ¼åˆ†éš”ï¼Œç„¡è·³éé¸é …ï¼", "danger");
                    }
                }
                await this.sleep(1000);

                // æƒ¡éˆé¨å£«åæ®ºè¦å‰‡åŸ·è¡Œ
                if (anti_kill_list.length && this.evil_knight_counter) {
                    const ak_target = anti_kill_list[0];
                    real_dead.push(ak_target);
                    this.evil_knight_counter = false;
                    this.log(`\nâš ï¸  æƒ¡éˆé¨å£«åæ®ºè¦å‰‡ï¼šè¢«${ak_target}è™Ÿç¥è·æŒ‡å®šï¼Œåæ®ºè©²ç¥è·ï¼åæ®ºæ¬¡æ•¸ç”¨å®Œï¼`, "warn");
                }

                // è™•ç†ç‹¼å¼Ÿå–®ç¨åˆ€äººçµæœ
                if (this.wolf_young_kill && alive_players.includes(this.wolf_young_kill)) {
                    if (this.players[this.wolf_young_kill].role !== "æƒ¡éˆé¨å£«") {
                        real_dead.push(this.wolf_young_kill);
                        this.log(`\nğŸº ç‹¼å¼Ÿå–®ç¨åˆ€æ®ºçµæœï¼š${this.wolf_young_kill}è™Ÿç©å®¶æ­»äº¡ï¼`);
                    }
                }

                // ç‹¼å¼Ÿé¡å¤–è¦å‰‡ï¼šç‹¼äººåœ˜æ»…å¾Œå¯å–®ç¨åˆ€äºº
                if (this.wolf_bro_awake && alive_wolfs.filter(w => w !== wolf_young[0]).length ===0 && wolf_young.length) {
                    this.log(`\nâš ï¸  ç‹¼å¼Ÿè¦å‰‡ï¼šæ‰€æœ‰ç‹¼äººå·²æ»…çµ•ï¼Œç‹¼å¼Ÿå–®ç¨åŸ·è¡Œåˆ€äººæ¬Šï¼`, "warn");
                    while (true) {
                        const input = await this.waitForInput();
                        const wy_kill = parseInt(input);
                        if (wy_kill ===0) break;
                        if (alive_players.includes(wy_kill)) {
                            real_dead.push(wy_kill);
                            this.log(`âœ… ç‹¼å¼Ÿå–®ç¨åˆ€æ®º ${wy_kill}è™Ÿç©å®¶ï¼`, "success");
                            break;
                        }
                    }
                }

                // è™•ç†ç‹¼åˆ€æœ€çµ‚çµæœ
                if (wolf_bite) {
                    if (this.players[wolf_bite].role === "æƒ¡éˆé¨å£«") {
                        this.log(`âœ… æƒ¡éˆé¨å£«è¦å‰‡ï¼šå¤œæ™šå…ç–«æ‰€æœ‰å‚·å®³ï¼ç‹¼åˆ€ç„¡æ•ˆ`, "success");
                    } else if (!real_dead.includes(wolf_bite)) {
                        real_dead.push(wolf_bite);
                    }
                }

                // å®ˆå¢“äººç²å¾—ä¸Šæ—¥æŠ•ç¥¨è³‡è¨Š
                const grave_keeper = Object.keys(this.players).map(Number).filter(p => this.players[p].role === "å®ˆå¢“äºº" && this.players[p].alive && !this.players[p].skill_lock);
                if (grave_keeper.length && this.day>1 && this.grave_last_vote_role) {
                    this.log(`\nâš°ï¸  å®ˆå¢“äºº(${grave_keeper[0]}è™Ÿ)çœçœ¼ï¼æ˜¨æ—¥è¢«æŠ•ç©å®¶ç‚ºã€${this.grave_last_vote_role}ã€‘é™£ç‡Ÿ`);
                    await this.sleep(1000);
                }

                // ========== å¤œæ™šæ­»äº¡è™•ç† ==========
                this.log("\nâ˜ ï¸  å¤©äº®äº†ï¼æ˜¨å¤œæ­»äº¡çš„ç©å®¶æœ‰ï¼š");
                const death_list = [...new Set(real_dead)];
                if (dreamer.length && death_list.includes(dreamer[0])) dreamer_dead = true;

                if (death_list.length) {
                    for (const dead of death_list) {
                        if (this.players[dead] && this.players[dead].alive && this.players[dead].role !== "æƒ¡éˆé¨å£«") {
                            this.players[dead].alive = false;
                            const dead_role = this.players[dead].role;
                            const team_tag = this.good_guys.includes(dead) ? "ğŸŸ¢å¥½äºº" : "ğŸ”´ç‹¼äºº";
                            this.log(`â†’ ${dead}è™Ÿç©å®¶ ${team_tag}ã€${dead_role}ã€‘`);

                            // çµäººæ ¸å¿ƒè¦å‰‡
                            if (dead_role === "çµäºº" && !this.players[dead].skill_lock) {
                                this.log(`${dead}è™Ÿçµäººæ­»äº¡ï¼é–‹æ§è¼¸å…¥ç›®æ¨™ç·¨è™Ÿï¼Œä¸é–‹è¼¸0ï¼š`);
                                const shoot = await this.waitForInput();
                                const shootTar = parseInt(shoot);
                                if (shoot !== "0" && alive_players.includes(shootTar)) {
                                    this.players[shootTar].alive = false;
                                    this.log(`âœ… çµäººé–‹æ§å¸¶èµ° ${shoot}è™Ÿï¼`, "success");
                                } else {
                                    this.log("âœ… çµäººé¸æ“‡ä¸é–‹æ§", "success");
                                }
                            }

                            // æƒ…ä¾¶æ®‰æƒ…è¦å‰‡
                            if (this.cupid_couple.includes(dead)) {
                                const lover = this.cupid_couple[0] === dead ? this.cupid_couple[1] : this.cupid_couple[0];
                                this.players[lover].alive = false;
                                this.players[lover].skill_lock = true;
                                this.log(`ğŸ’” æƒ…ä¾¶è¦å‰‡ï¼š${lover}è™Ÿæ®‰æƒ…æ­»äº¡ + æŠ€èƒ½æ°¸ä¹…å°å°ï¼`);
                            }

                            // ç‹¼ç‹/ç™½ç‹¼ç‹/é»‘ç‹¼ç‹ æŠ€èƒ½åš´æ ¼å€åˆ†
                            if (dead_role === "ç‹¼ç‹") {
                                this.log(`ğŸº ç‹¼ç‹è¦å‰‡ï¼šæ­»äº¡å³å¯å¸¶äººã€ç„¡é™åˆ¶ã€‘ï¼Œè¢«åˆ€/è¢«æŠ•/è‡ªçˆ†çš†å¯ç™¼å‹•ï¼`);
                                const bite = await this.waitForInput();
                                const biteTar = parseInt(bite);
                                if (bite !=="0" && alive_players.includes(biteTar)) {
                                    this.players[biteTar].alive = false;
                                    this.log(`âœ… ç‹¼ç‹å’¬æ®º ${bite}è™Ÿç©å®¶ï¼`, "success");
                                } else {
                                    this.log("âœ… ç‹¼ç‹é¸æ“‡ä¸å¸¶äºº", "success");
                                }
                            }

                            if (dead_role === "ç™½ç‹¼ç‹") {
                                this.log(`ğŸº ç™½ç‹¼ç‹è¦å‰‡ï¼šåƒ…è‡ªçˆ†æ­»äº¡æ‰èƒ½å¸¶äººï¼Œå…¶ä»–æ­»äº¡ç„¡æ³•ç™¼å‹•æŠ€èƒ½ï¼`);
                            }

                            if (dead_role === "é»‘ç‹¼ç‹" && !this.players[dead].skill_lock) {
                                this.log(`ğŸº é»‘ç‹¼ç‹è¦å‰‡ï¼šè¢«åˆ€/è¢«æŠ•æ­»äº¡å¯å¸¶äººï¼Œè‡ªçˆ†çµ•å°ä¸èƒ½ç™¼å‹•ï¼`);
                                const bite = await this.waitForInput();
                                const biteTar = parseInt(bite);
                                if (bite !=="0" && alive_players.includes(biteTar)) {
                                    this.players[biteTar].alive = false;
                                    this.log(`âœ… é»‘ç‹¼ç‹å’¬æ®º ${bite}è™Ÿç©å®¶ï¼`, "success");
                                } else {
                                    this.log("âœ… é»‘ç‹¼ç‹é¸æ“‡ä¸å¸¶äºº", "success");
                                }
                            }

                            // ç‹¼ç¾äººæ®‰æƒ…è¦å‰‡
                            if (dead_role === "ç‹¼ç¾äºº") {
                                this.log(`${dead}è™Ÿç‹¼ç¾äººæ­»äº¡ï¼è«‹è¼¸å…¥è¢«é­…æƒ‘çš„ç©å®¶ç·¨è™Ÿï¼Œä¸å¸¶è¼¸0ï¼š`);
                                const charm = await this.waitForInput();
                                const charmTar = parseInt(charm);
                                if (charm !=="0" && alive_players.includes(charmTar)) {
                                    this.players[charmTar].alive = false;
                                    this.players[charmTar].skill_lock = true;
                                    this.log(`ğŸ’” ${charm}è™Ÿè¢«é­…æƒ‘ç©å®¶æ®‰æƒ…æ­»äº¡+æŠ€èƒ½å°å°ï¼`);
                                } else {
                                    this.log("âœ… ç‹¼ç¾äººé¸æ“‡ä¸å¸¶äºº", "success");
                                }
                            }
                        }
                    }

                    // æ”å¤¢äººè¦å‰‡ï¼šæ”å¤¢äººæ­»å‰‡å‚¬çœ ç›®æ¨™æ®‰æƒ…
                    if (dreamer_dead && dream_target !==-1 && this.players[dream_target].alive) {
                        this.players[dream_target].alive = false;
                        this.players[dream_target].skill_lock = true;
                        this.log(`ğŸ’¤ æ”å¤¢äººè¦å‰‡ï¼šæ”å¤¢äººæ­»äº¡ â†’ ${dream_target}è™Ÿå‚¬çœ ç›®æ¨™æ®‰æƒ…+æŠ€èƒ½å°å°ï¼`);
                    }
                } else {
                    this.log("â†’ å¹³å®‰å¤œï¼Œç„¡äººæ­»äº¡");
                }

                // é­”è¡“å¸«äº¤æ›å¾©åŸ
                if (this.magician_swap_pair.length) {
                    const [s1, s2] = this.magician_swap_pair;
                    [this.players[s1].role, this.players[s2].role] = [this.players[s2].role, this.players[s1].role];
                    this.log(`\nğŸª„ é­”è¡“å¸«è¦å‰‡ï¼šå¤©äº®å¾Œ ${s1}è™Ÿèˆ‡{s2}è™Ÿèº«ä»½æŠ€èƒ½å¾©åŸï¼`);
                    this.magician_swap_pair = [];
                }

                this.check_win_condition();
                await this.sleep(2000);
            }

            // ========== âœ… ç™½å¤©å…¬æŠ•éšæ®µ âœ… ==========
            async day_vote() {
                if (this.game_over) return;
                this.log(`\n======= ç¬¬${this.day}å¤© Â· ç™½å¤© =======`);
                const alive_players = this.get_alive_players();
                const alive_wolfs = this.get_alive_wolfs();
                const vote_records = {};
                alive_players.forEach(p => vote_records[p] = 0);
                let explode_trigger = false;
                let explode_wolf_role = "";

                // é¨å£«æ±ºé¬¥ç’°ç¯€
                const knight = Object.keys(this.players).map(Number).filter(p => this.players[p].role === "é¨å£«" && this.players[p].alive && !this.players[p].skill_lock);
                if (knight.length) {
                    this.log(`\nâš”ï¸  ${knight[0]}è™Ÿé¨å£«æ˜¯å¦ç™¼å‹•æ±ºé¬¥ï¼Ÿç™¼å‹•è¼¸1ï¼Œä¸ç™¼å‹•è¼¸0ï¼š`);
                    const duel = await this.waitForInput();
                    if (duel === "1") {
                        this.log("è«‹é¸æ“‡æ±ºé¬¥ç›®æ¨™ç·¨è™Ÿï¼Œè¼¸0è·³éï¼š");
                        const tar = parseInt(await this.waitForInput());
                        if (tar !==0) {
                            const tar_team = this.getRoleTeam(this.players[tar].role);
                            if (tar_team === "ç‹¼äººé™£ç‡Ÿ") {
                                this.players[tar].alive = false;
                                this.log(`âœ… æ±ºé¬¥æˆåŠŸï¼${tar}è™Ÿç‹¼äººæ­»äº¡ï¼Œå³å°‡é€²å…¥é»‘å¤œï¼`, "success");
                                this.check_win_condition();
                                await this.sleep(2000);
                                return;
                            } else {
                                this.players[knight[0]].alive = false;
                                this.log(`âŒ æ±ºé¬¥å¤±æ•—ï¼é¨å£«æ­»äº¡ï¼Œè¨è«–ç¹¼çºŒ`, "danger");
                            }
                        } else {
                            this.log("âœ… é¨å£«é¸æ“‡è·³éæ±ºé¬¥æŠ€èƒ½", "success");
                        }
                    }
                }

                // æŠ•ç¥¨éšæ®µ - è¼¸0è§¸ç™¼è‡ªçˆ†
                if (alive_players.length) {
                    this.log(`\nğŸ—³ï¸  å…¬æŠ•é–‹å§‹ï¼å­˜æ´»ç©å®¶ï¼š${alive_players}`);
                    this.log(`ã€æ ¸å¿ƒè¦å‰‡ã€‘æŠ•ç¥¨è¼¸0 â†’ ç«‹å³è©¢å•ç‹¼äººè‡ªçˆ†ï¼Œæœ‰è‡ªçˆ†å¼·åˆ¶å…¥å¤œï¼Œç„¡è‡ªçˆ†ç¹¼çºŒæŠ•ç¥¨ï¼`);
                    for (const voter of alive_players) {
                        if (!this.players[voter].can_vote || explode_trigger) break;
                        while (true) {
                            this.log(`${voter}è™Ÿ(${this.players[voter]['role']})è«‹æŠ•ç¥¨æ”¾é€ï¼š`);
                            const input = await this.waitForInput();
                            const vote = parseInt(input);
                            if (vote ===0) {
                                this.log("\nâš ï¸  åµæ¸¬åˆ°æŠ•ç¥¨è¼¸0ï¼Œç«‹å³è§¸ç™¼ç‹¼äººè‡ªçˆ†è©¢å•ï¼", "warn");
                                this.log("æ˜¯å¦æœ‰ç‹¼äººè¦è‡ªçˆ†ï¼Ÿ â†’ 1=æœ‰è‡ªçˆ†  0=ç„¡è‡ªçˆ†ï¼š");
                                const wolf_explode_ans = await this.waitForInput();
                                if (wolf_explode_ans === "1") {
                                    explode_trigger = true;
                                    this.log(`è«‹é¸æ“‡è¦è‡ªçˆ†çš„ç‹¼äººç·¨è™Ÿ (å­˜æ´»ç‹¼äººï¼š${alive_wolfs})ï¼š`);
                                    while (true) {
                                        const wolf_exp_id = parseInt(await this.waitForInput());
                                        if (alive_wolfs.includes(wolf_exp_id)) {
                                            this.players[wolf_exp_id].alive = false;
                                            explode_wolf_role = this.players[wolf_exp_id].role;
                                            this.log(`âœ… ${wolf_exp_id}è™Ÿç‹¼äºº(${explode_wolf_role})è‡ªçˆ†æˆåŠŸï¼`, "success");

                                            // ç™½ç‹¼ç‹è¦å‰‡
                                            if (explode_wolf_role === "ç™½ç‹¼ç‹") {
                                                this.log(`âœ… ç™½ç‹¼ç‹è¦å‰‡ï¼šè‡ªçˆ†æˆåŠŸï¼ç™¼å‹•å¸¶äººæŠ€èƒ½ï¼`);
                                                const bite_tar = await this.waitForInput();
                                                const bt = parseInt(bite_tar);
                                                if (bite_tar !=="0" && alive_players.includes(bt)) {
                                                    this.players[bt].alive = false;
                                                    this.log(`âœ… ç™½ç‹¼ç‹å’¬æ­» ${bite_tar}è™Ÿç©å®¶ï¼`, "success");
                                                }
                                            }

                                            // ç‹¼ç‹è¦å‰‡
                                            if (explode_wolf_role === "ç‹¼ç‹") {
                                                this.log(`âœ… ç‹¼ç‹è¦å‰‡ï¼šè‡ªçˆ†å±¬æ–¼æ­»äº¡ï¼Œå¯ç™¼å‹•å¸¶äººæŠ€èƒ½ï¼`);
                                                const bite_tar = await this.waitForInput();
                                                const bt = parseInt(bite_tar);
                                                if (bite_tar !=="0" && alive_players.includes(bt)) {
                                                    this.players[bt].alive = false;
                                                    this.log(`âœ… ç‹¼ç‹å’¬æ­» ${bite_tar}è™Ÿç©å®¶ï¼`, "success");
                                                }
                                            }

                                            // é»‘ç‹¼ç‹è¦å‰‡
                                            if (explode_wolf_role === "é»‘ç‹¼ç‹") {
                                                this.log(`âŒ é»‘ç‹¼ç‹è¦å‰‡ï¼šè‡ªçˆ†æ­»äº¡ï¼Œç„¡æ³•ç™¼å‹•ä»»ä½•å¸¶äººæŠ€èƒ½ï¼`, "danger");
                                            }

                                            // è¡€æœˆä½¿è€…è¦å‰‡
                                            if (explode_wolf_role === "è¡€æœˆä½¿è€…") {
                                                this.log(`âœ… è¡€æœˆä½¿è€…è‡ªçˆ†ï¼ç•¶æ™šæ‰€æœ‰å¥½äººæŠ€èƒ½è¢«å°å°ï¼`, "success");
                                            }

                                            this.log("âœ… å¼·åˆ¶çµæŸç™½å¤©ï¼Œç«‹å³é€²å…¥é»‘å¤œï¼");
                                            break;
                                        }
                                    }
                                    break;
                                } else {
                                    this.log("âœ… ç„¡ç‹¼äººè‡ªçˆ†ï¼Œç¹¼çºŒé€²è¡Œå…¬æŠ•æŠ•ç¥¨ï¼", "success");
                                    continue;
                                }
                            } else if (alive_players.includes(vote)) {
                                vote_records[vote] +=1;
                                this.log(`âœ… ${voter}è™ŸæŠ•ç¥¨çµ¦ ${vote}è™Ÿ`, "success");
                                break;
                            } else {
                                this.log("è¼¸å…¥éŒ¯èª¤ï¼è«‹é¸æ“‡å­˜æ´»ç©å®¶ç·¨è™Ÿï¼Œè¼¸0è§¸ç™¼è‡ªçˆ†è©¢å•ï¼", "danger");
                            }
                        }
                    }
                }

                // æœ‰è‡ªçˆ† â†’ å¼·åˆ¶å…¥å¤œ
                if (explode_trigger) {
                    this.check_win_condition();
                    await this.sleep(2000);
                    return;
                }

                // çµ±è¨ˆæŠ•ç¥¨çµæœ
                if (alive_players.length && Object.keys(vote_records).length) {
                    const max_vote = Math.max(...Object.values(vote_records));
                    const vote_target = Object.keys(vote_records).filter(p => vote_records[p] === max_vote).map(Number);
                    if (vote_target.length ===1) {
                        const vt = vote_target[0];
                        this.grave_last_vote_role = this.getRoleTeam(this.players[vt].role);
                        const vt_role = this.players[vt].role;

                        // ç™½ç—´è¦å‰‡
                        if (vt_role === "ç™½ç—´") {
                            this.players[vt].can_vote = false;
                            this.log(`ğŸ¤ ${vt}è™Ÿç™½ç—´ç¿»ç‰Œä¸æ­»ï¼Œå¤±å»æŠ•ç¥¨æ¬Šï¼`);
                        } else {
                            // è¡€æœˆä½¿è€…è¦å‰‡
                            if (vt_role === "è¡€æœˆä½¿è€…" && alive_wolfs.length ===1) {
                                this.log(`ğŸŒ™ è¡€æœˆä½¿è€…è¦å‰‡ï¼šæœ€å¾Œç‹¼äººè¢«æŠ•ï¼Œç¿»ç‰Œå­˜æ´»è‡³ä¸‹ä¸€å€‹ç™½å¤©ï¼`);
                            } else {
                                this.players[vt].alive = false;
                                const team_tag = this.good_guys.includes(vt) ? "ğŸŸ¢å¥½äºº" : "ğŸ”´ç‹¼äºº";
                                this.log(`âœ… ${vt}è™Ÿè¢«å…¬æŠ•å‡ºå±€ï¼${team_tag}ã€${vt_role}ã€‘`, "success");

                                // çµäººè¢«æŠ•é–‹æ§
                                if (vt_role === "çµäºº" && !this.players[vt].skill_lock) {
                                    this.log(`${vt}è™Ÿçµäººè¢«æŠ•ï¼é–‹æ§è¼¸å…¥ç›®æ¨™ç·¨è™Ÿï¼Œä¸é–‹è¼¸0ï¼š`);
                                    const shoot = await this.waitForInput();
                                    const st = parseInt(shoot);
                                    if (shoot !=="0" && alive_players.includes(st)) {
                                        this.players[st].alive = false;
                                        this.log(`âœ… çµäººé–‹æ§å¸¶èµ° ${shoot}è™Ÿï¼`, "success");
                                    } else {
                                        this.log("âœ… çµäººé¸æ“‡ä¸é–‹æ§", "success");
                                    }
                                }
                            }
                        }
                    } else {
                        this.log(`ğŸ¤ æŠ•ç¥¨å¹³æ‰‹ï¼${vote_target}è™ŸPKï¼Œç„¡äººå‡ºå±€`);
                    }
                }

                this.check_win_condition();
                await this.sleep(2000);
            }

            // ========== âœ… å‹åˆ©æ¢ä»¶ ==========
            check_win_condition() {
                const alive_wolfs = this.get_alive_wolfs();
                const alive_good = this.get_alive_good();

                if (alive_wolfs.length === 0) {
                    this.game_over = true;
                    this.winner = "å¥½äººé™£ç‡Ÿ";
                    this.log(`\nğŸ‰ éŠæˆ²çµæŸï¼ç²å‹é™£ç‡Ÿï¼šğŸŸ¢${this.winner} ğŸ‰`, "success");
                    this.log("âœ… æ‰€æœ‰ç‹¼äººå·²è¢«æ¶ˆæ»…ï¼Œå¥½äººé™£ç‡Ÿå± ç‹¼ç²å‹ï¼", "success");
                } else if (alive_good.length === 0) {
                    this.game_over = true;
                    this.winner = "ç‹¼äººé™£ç‡Ÿ";
                    this.log(`\nğŸ‰ éŠæˆ²çµæŸï¼ç²å‹é™£ç‡Ÿï¼šğŸ”´${this.winner} ğŸ‰`, "wolf");
                    this.log("âœ… æ‰€æœ‰å¥½äººå·²è¢«å± æ»…ï¼Œç‹¼äººé™£ç‡Ÿå± åŸç²å‹ï¼", "wolf");
                }
            }

            // ========== é¡¯ç¤ºæ‰€æœ‰ç©å®¶çœŸå¯¦èº«åˆ† ==========
            show_all_roles() {
                this.log("\n======= ğŸ“œ æœ¬å±€æ‰€æœ‰ç©å®¶çœŸå¯¦èº«åˆ†ã€é™£ç‡Ÿæ¸…æ™°ç‰ˆã€‘ =======");
                for (let p in this.players) {
                    const pid = parseInt(p);
                    const status = this.players[pid].alive ? "âœ…å­˜æ´»" : "âŒæ­»äº¡";
                    const vote = this.players[pid].can_vote ? "ğŸ—³ï¸å¯æŠ•ç¥¨" : "âŒç„¡æŠ•ç¥¨æ¬Š";
                    const lock = this.players[pid].skill_lock ? "ğŸ”’æŠ€èƒ½å°å°" : "âœ…æŠ€èƒ½å¯ç”¨";
                    const team_tag = this.good_guys.includes(pid) ? "ğŸŸ¢å¥½äºº" : "ğŸ”´ç‹¼äºº";
                    this.log(`${pid}è™Ÿï¼š${team_tag}ã€${this.players[pid].role}ã€‘ ${status} ${vote} ${lock}`);
                }
            }

            // å»¶é²å‡½æ•¸
            sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            // ========== âœ… å®Œæ•´éŠæˆ²ä¸»å¾ªç’° ==========
            async start_game() {
                await this.manual_role_setup();
                while (true) {
                    await this.init_game();
                    while (!this.game_over) {
                        await this.night_action();
                        if (this.game_over) break;
                        await this.day_vote();
                        this.day +=1;
                    }
                    this.show_all_roles();
                    this.log("\nğŸ® æ˜¯å¦å†ä¾†ä¸€æ¬¡ï¼Ÿè¼¸å…¥ã€å†ä¾†ä¸€æ¬¡ã€‘é‡é–‹éŠæˆ²ï¼Œè¼¸å…¥å…¶ä»–å…§å®¹çµæŸï¼š");
                    const restart = await this.waitForInput();
                    if (restart !== "å†ä¾†ä¸€æ¬¡") {
                        this.log("\nğŸ‘‹ è¬è¬ç©ç‹¼äººæ®ºéŠæˆ²ï¼ä¸‹æ¬¡å†è¦‹ï½");
                        break;
                    } else {
                        this.log("\n=====================================");
                        this.log("ğŸ® æº–å‚™é‡æ–°é–‹å±€ï¼å¯æ‰‹å‹•åˆ†é…è§’è‰²ï¼");
                        this.log("=====================================");
                        await this.sleep(2000);
                    }
                }
            }
        }

        // å•Ÿå‹•éŠæˆ²
        const game = new WerewolfGame();
        game.start_game();
    </script>
</body>
</html>